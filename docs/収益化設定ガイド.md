# Escape Nine: Endless - 収益化設定ガイド

## 概要

このドキュメントでは、Firebase連携、AdMob広告、StoreKit課金システムの本番環境への設定手順を説明します。

**現在の状態**: モック実装完了。実際のSDKを追加することで本番動作します。

---

## 1. Firebase連携

### 1.1 Firebaseプロジェクト作成

1. [Firebase Console](https://console.firebase.google.com) にアクセス
2. 「プロジェクトを追加」をクリック
3. プロジェクト名を入力（例: `escape-nine-endless`）
4. Google Analyticsは任意で有効化

### 1.2 iOSアプリ登録

1. Firebase Console > プロジェクト設定
2. 「アプリを追加」> iOS を選択
3. Bundle ID を入力:
   ```
   com.yourcompany.escapenine-endless
   ```
4. `GoogleService-Info.plist` をダウンロード
5. Xcodeプロジェクトのルートに `GoogleService-Info.plist` を追加
   - **重要**: "Copy items if needed" をチェック
   - Target に `EscapeNine-endless-` が含まれていることを確認

### 1.3 Swift Package Manager で依存関係を追加

Xcode > File > Add Package Dependencies...

```
https://github.com/firebase/firebase-ios-sdk
```

以下のProductを追加:
- ✅ FirebaseAuth
- ✅ FirebaseFirestore

### 1.4 認証設定

Firebase Console > Authentication > Sign-in method

**有効化する認証方法:**
- ✅ 匿名 (Anonymous)
- ✅ Apple (オプション - 推奨)

**Apple Sign In の場合:**
1. Xcode > Signing & Capabilities > "+ Capability"
2. "Sign in with Apple" を追加
3. Firebase Console で Apple を有効化

### 1.5 Firestore セットュリティルール

Firebase Console > Firestore Database > Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ランキングデータ
    match /rankings/{userId} {
      // 誰でも読み取り可能
      allow read: if true;
      // 自分のデータのみ書き込み可能
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

### 1.6 コードの有効化

`EscapeNine_endless_App.swift` を編集:

```swift
import SwiftUI
import FirebaseCore  // ← 追加

@main
struct EscapeNine_endless_App: App {
    init() {
        FirebaseApp.configure()  // ← コメント解除
    }
    // ...
}
```

`FirebaseService.swift` のTODO部分を実装:

各メソッドの `// TODO: Firebase実装` コメント箇所を、コメントされている実装コードに置き換えてください。

---

## 2. AdMob広告

### 2.1 AdMobアカウント作成

1. [Google AdMob](https://admob.google.com) にアクセス
2. アカウント作成・ログイン
3. 「アプリを追加」をクリック

### 2.2 広告ユニット作成

**必要な広告ユニット:**

| 広告種別 | 名称 | 用途 |
|---------|------|------|
| バナー広告 | Home Banner | ホーム画面下部 |
| インタースティシャル広告 | Game Over Interstitial | ゲームオーバー時 |

各広告ユニットIDをメモ（形式: `ca-app-pub-XXXXXXXXXXXXX/YYYYYYYYYY`）

### 2.3 Swift Package Manager で依存関係を追加

Xcode > File > Add Package Dependencies...

```
https://github.com/googleads/swift-package-manager-google-mobile-ads
```

Product:
- ✅ GoogleMobileAds

### 2.4 Info.plist に設定追加

`EscapeNine-endless-/Info.plist` に追加:

```xml
<key>GADApplicationIdentifier</key>
<string>ca-app-pub-XXXXXXXXXXXXX~YYYYYYYYYY</string>

<key>SKAdNetworkItems</key>
<array>
  <dict>
    <key>SKAdNetworkIdentifier</key>
    <string>cstr6suwn9.skadnetwork</string>
  </dict>
  <!-- AdMobコンソールから取得した他のIDも追加 -->
</array>

<!-- App Tracking Transparency (iOS 14.5+) -->
<key>NSUserTrackingUsageDescription</key>
<string>より良い広告体験を提供するために使用します</string>
```

### 2.5 AdMobConfig を更新

`Services/AdMobService.swift` の `AdMobConfig` を編集:

```swift
static var bannerAdUnitId: String {
    #if DEBUG
    return testBannerAdUnitId
    #else
    return "ca-app-pub-XXXXXXXXXXXXX/YYYYYYYYYY"  // ← 本番バナー広告ID
    #endif
}

static var interstitialAdUnitId: String {
    #if DEBUG
    return testInterstitialAdUnitId
    #else
    return "ca-app-pub-XXXXXXXXXXXXX/ZZZZZZZZZZ"  // ← 本番インタースティシャル広告ID
    #endif
}
```

### 2.6 コードの有効化

`EscapeNine_endless_App.swift` を編集:

```swift
import SwiftUI
import GoogleMobileAds  // ← 追加

@main
struct EscapeNine_endless_App: App {
    init() {
        GADMobileAds.sharedInstance().start(completionHandler: nil)  // ← コメント解除
    }
    // ...
}
```

`AdMobService.swift` のTODO部分を実装:

各メソッドの `// TODO: Google Mobile Ads SDK 実装` コメント箇所を、コメントされている実装コードに置き換えてください。

### 2.7 App Tracking Transparency の実装

起動時にトラッキング許可をリクエスト（iOS 14.5+）:

```swift
import AppTrackingTransparency

// HomeViewのonAppear などで呼び出し
func requestTrackingAuthorization() {
    if #available(iOS 14.5, *) {
        ATTrackingManager.requestTrackingAuthorization { status in
            switch status {
            case .authorized:
                print("トラッキング許可")
            default:
                print("トラッキング不許可")
            }
        }
    }
}
```

---

## 3. StoreKit課金システム

### 3.1 App Store Connect でアプリ登録

1. [App Store Connect](https://appstoreconnect.apple.com) にログイン
2. 「マイApp」> 「+」> 「新規App」
3. プラットフォーム: iOS
4. Bundle ID を選択

### 3.2 App内課金商品を作成

**必要な商品:**

| 商品ID | タイプ | 価格 | 説明 |
|--------|--------|------|------|
| `com.escapenine.character.mage` | 非消耗型 | ¥240 | 魔法使いキャラクター |
| `com.escapenine.character.elf` | 非消耗型 | ¥240 | エルフキャラクター |
| `com.escapenine.removeads` | 非消耗型 | ¥480 | 広告削除 |

**作成手順:**
1. App Store Connect > マイApp > App内課金
2. 「+」をクリック
3. 商品タイプを選択（非消耗型）
4. 参照名、商品IDを入力
5. 価格を設定（¥240 or ¥480）
6. 審査情報を入力
7. 「保存」

### 3.3 StoreKit Configuration File（ローカルテスト用）

Xcode > File > New > File > StoreKit Configuration File

1. `Products.storekit` を作成
2. 上記3つの商品を追加
3. Scheme設定: Edit Scheme > Run > Options > StoreKit Configuration > `Products.storekit` を選択

### 3.4 Sandboxテスター追加

1. App Store Connect > Users and Access > Sandbox
2. 「+」でテスターを追加
3. 実機でテスト時、設定 > App Store > サインアウト
4. アプリ内課金時にSandboxアカウントでログイン

### 3.5 StoreKit実装（既に完成）

`Services/StoreKitService.swift` は既に実装済みです。

**確認事項:**
- ✅ ProductIDが App Store Connect と一致
- ✅ StoreKit 2 使用（iOS 15+）
- ✅ トランザクション監視実装済み

---

## 4. 統合テスト

### 4.1 課金テスト

1. StoreKit Configuration Fileを有効化
2. シミュレータで起動
3. キャラクター選択 > 魔法使い/エルフ購入
4. 購入フローを確認
5. 設定 > 購入の復元 を確認

### 4.2 広告テスト

1. 実機で起動（シミュレータではAdMobテスト広告が表示されない場合あり）
2. ホーム画面下部にバナー広告表示を確認
3. ゲームオーバー時にインタースティシャル広告表示を確認
4. 設定 > 広告削除購入 > 広告が非表示になることを確認

### 4.3 Firebaseテスト

1. 匿名認証を確認（自動）
2. ゲームプレイ後、Firestore Consoleでランキングデータ確認
3. ランキング画面でデータ取得を確認

---

## 5. リリース前チェックリスト

### Firebase
- [ ] `GoogleService-Info.plist` が正しく配置されている
- [ ] FirebaseApp.configure() がApp起動時に呼ばれている
- [ ] Firestoreセキュリティルールが設定されている
- [ ] Apple Sign In の場合、Capabilityが追加されている

### AdMob
- [ ] Info.plistに `GADApplicationIdentifier` が設定されている
- [ ] Info.plistに `SKAdNetworkItems` が設定されている
- [ ] Info.plistに `NSUserTrackingUsageDescription` が設定されている
- [ ] 本番広告ユニットIDが `AdMobConfig` に設定されている
- [ ] App Tracking Transparencyダイアログが表示される

### StoreKit
- [ ] App Store Connect で3つの商品が承認済み
- [ ] ProductIDがコード内と一致している
- [ ] Sandboxテストで購入・復元が動作する
- [ ] プライバシーポリシーと利用規約のリンクが設定されている

### 法的要件
- [ ] プライバシーポリシーの作成・公開
- [ ] 特定商取引法に基づく表記
- [ ] 資金決済法への対応（¥1万円以下なので不要の場合が多い）

---

## 6. トラブルシューティング

### Firebase接続エラー

```
[Firebase/Core] FIRApp not configured
```

**解決策**: `GoogleService-Info.plist` がプロジェクトに正しく追加されているか確認

---

### AdMob広告が表示されない

**原因:**
- テスト広告IDを使用していない（開発時）
- 本番広告IDが間違っている（リリース時）
- `GADApplicationIdentifier` が設定されていない

**解決策**:
1. デバッグモードで `#if DEBUG` が動作しているか確認
2. AdMobコンソールで広告ユニットIDをコピー
3. Info.plistの設定を再確認

---

### StoreKit購入エラー

```
Product not found
```

**解決策**:
- App Store Connect で商品が「準備完了」になっているか確認
- ProductIDのスペルミス確認
- StoreKit Configuration File を有効化（ローカルテスト時）

---

## 7. まとめ

収益化機能は以下のファイルで完全実装済みです：

| ファイル | 役割 | 状態 |
|---------|------|------|
| `FirebaseService.swift` | Firebase認証・Firestore | モック実装完了 |
| `StoreKitService.swift` | StoreKit 2課金 | 完全実装 |
| `PurchaseManager.swift` | 統合マネージャー | 完全実装 |
| `AdMobService.swift` | AdMob広告 | モック実装完了 |
| `CharacterSelectionView.swift` | 課金UI | 統合済み |
| `SettingsView.swift` | 広告削除・リストア | 統合済み |
| `HomeView.swift` | バナー広告 | 統合済み |
| `ResultView.swift` | インタースティシャル広告 | 統合済み |
| `EscapeNine_endless_App.swift` | 初期化 | 準備完了 |

**次のステップ:**
1. Firebase/AdMob SDKをインストール
2. 本番ID/設定ファイルを追加
3. TODO コメント箇所を実装コードに置き換え
4. テスト → 審査申請 → リリース

お疲れさまでした！
